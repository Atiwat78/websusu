<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <title>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ & ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" rel="stylesheet" />
  <style>
    body{font-family:'Poppins',sans-serif;background:#f4f7f6;}
    .navbar{background:#000}
    .box{background:#fff;border-radius:12px;padding:30px;box-shadow:0 5px 20px rgba(0,0,0,.15);margin-top:20px;}

    /* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ Timeline ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
    .timeline{position:relative;list-style:none;margin:0;padding-left:60px;margin-top:1.5rem;}
    /* ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô "‡πÄ‡∏™‡πâ‡∏ô‡∏õ‡∏∞" ‡∏™‡∏µ‡∏™‡πâ‡∏° */
    .timeline::before{content:"";position:absolute;left:30px;top:0;bottom:0;width:4px;background-image:repeating-linear-gradient(to bottom,#9ca3af 0 8px,transparent 8px 16px);border-radius:2px;}
    .timeline-item{display:flex;align-items:flex-start;margin-bottom:1.75rem;}
    .timeline-icon{flex:0 0 32px;width:32px;height:32px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:.9rem;margin-right:14px;position:relative;transition:.15s;}
    .timeline-content{flex:1;}
    .timeline-content h6{margin:0;font-weight:500;}
    .done-time{display:block;margin-top:4px;}

    /* === Checkbox style === */
    .timeline-icon input[type="checkbox"]{opacity:0;position:absolute;inset:0;z-index:2;cursor:pointer;}
    .timeline-icon::after{content:"";position:absolute;top:8px;left:8px;width:16px;height:16px;border:2px solid #fff;border-radius:4px;background:transparent;pointer-events:none;}
    .timeline-icon.checked{background:#198754!important;}
    .timeline-icon.checked::after{background:#fff url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16' fill='%23028a0f'%3E%3Cpath d='M13.485 1.929a1 1 0 0 1 1.53 1.15l-.071.082-8 8a1 1 0 0 1-1.32.084l-.094-.083-4-4a1 1 0 0 1 1.32-1.497l.094.083L6 8.586l7.485-7.485Z'/%3E%3C/svg%3E") no-repeat center/14px;}
    .border-flash{box-shadow:0 0 0 2px #198754 inset!important;transition:box-shadow .8s ease-out;}
    
  </style>
</head>
<body>
<!-- ‚òÖ‚òÖ Navbar ‡πÉ‡∏™‡πà‡πÇ‡∏•‡πÇ‡∏Å‡πâ + ‡∏õ‡∏∏‡πà‡∏° logout ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô user_overview ‚òÖ‚òÖ -->
<nav class="navbar navbar-expand-lg navbar-dark">
  <div class="container-fluid">
    <a class="navbar-brand ms-2 d-flex align-items-center" href="{{ url_for('admin_dashboard') }}">
      <!-- ‡πÇ‡∏•‡πÇ‡∏Å‡πâ‡∏†‡∏≤‡∏¢‡πÉ‡∏ô static; ‡∏ñ‡πâ‡∏≤‡πÉ‡∏ä‡πâ‡∏•‡∏¥‡∏á‡∏Å‡πå Wikipedia ‡∏Å‡πá‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô src ‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ -->
      <img src="https://upload.wikimedia.org/wikipedia/th/4/4e/Kalasin_University_Seal.svg"
           style="height:50px;margin-right:10px">
           
      <strong>Kalasin University ‚Äì Admin</strong>
    </a>

    <div class="ms-auto">
      <a href="{{ url_for('logout') }}" class="btn btn-danger fw-bold px-4 py-2">
        <i class="fas fa-sign-out-alt me-1"></i> ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö
      </a>
    </div>
  </div>
</nav>


<div class="container box">
  <h3 class="mb-4 text-center">üìã ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</h3>
  <div class="card p-4">
    <h5><i class="fas fa-user"></i> {{ user.username }}</h5>
    <p><i class="fas fa-id-badge"></i> {{ user.first_name }} {{ user.last_name }}</p>
    <p><i class="fas fa-building-columns"></i> {{ faculty_th }}</p>
    <p><i class="fas fa-envelope"></i> {{ user.email }}</p>
  </div>

  <h4 class="mt-4 mb-3"><i class="fas fa-chart-line"></i> ‡πÑ‡∏ó‡∏°‡πå‡πÑ‡∏•‡∏ô‡πå‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</h4>

  <ul class="timeline">
{% if steps and steps|length > 0 %}
  {% for step in steps %}
    {% if step.order_no != 10 or show_kkk %}
    <li class="timeline-item">

      <!-- ‚ñà ‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏Å + ‡πÄ‡∏ä‡πá‡∏Å‡∏ö‡πá‡∏≠‡∏Å‡∏ã‡πå ‚ñà -->
      <span class="timeline-icon {{ 'checked' if step.is_done else 'bg-secondary text-white' }}"
            id="ico-{{ step.id }}">
        <input type="checkbox"
               {% if step.is_done %}checked{% endif %}
               onchange="toggleStep(this, {{ step.id }})">
      </span>

      <!-- ‚ñà ‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤ ‚ñà -->
      <div class="timeline-content">
        <h6>{{ step.order_no }}. {{ step.title }}</h6>

        {# ‚îÄ‚îÄ ‡πÄ‡∏ß‡∏•‡∏≤ ‚îÄ‚îÄ #}
        {% if step.show_time %}
          <small id="time-{{ step.id }}"
                 class="text-muted done-time {% if not (step.is_done and step.done_at) %}d-none{% endif %}">
            {% if step.is_done and step.done_at %}
              <i class="fas fa-clock"></i> {{ step.done_at.strftime('%d/%m/%Y %H:%M') }}
            {% endif %}
          </small>
        {% endif %}

        {# ‚îÄ‚îÄ ‡∏ä‡πà‡∏≠‡∏á‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏ ‚îÄ‚îÄ #}
        <textarea class="form-control comment-area mt-2"
                  placeholder="‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏..."
                  id="cmt-{{ step.id }}"
                  onblur="saveComment({{ step.id }})">{{ step.comment or '' }}</textarea>

{# ---- ‡∏ú‡∏π‡πâ‡∏ó‡∏£‡∏á‡∏Ø ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ç‡∏±‡πâ‡∏ô 8 ‡πÅ‡∏•‡∏∞ 9 ---- #}
{#  ‚îÄ‚îÄ ‡∏™‡πà‡∏ß‡∏ô‡πÉ‡∏ô‡∏•‡∏π‡∏õ step ‚îÄ‚îÄ  #}
{% if step.order_no == 9 %}
  <div class="d-flex flex-column gap-2 mt-2 ps-4">

    {% for e in range(3) %}
    <div class="d-flex align-items-center gap-1">

      <!-- ‡∏ï‡∏¥‡πä‡∏Å‡∏ß‡πà‡∏≤‡∏ú‡∏π‡πâ‡∏ó‡∏£‡∏á‡∏Ø ‡∏™‡πà‡∏á‡∏ú‡∏•‡πÅ‡∏•‡πâ‡∏ß -->
      <input type="checkbox"
             class="form-check-input me-1"
             id="exp-{{ step.id }}-{{ e }}"
             onchange="toggleExpert(this, {{ step.id }}, {{ e }})">

      <span>‡∏ú‡∏π‡πâ‡∏ó‡∏£‡∏á‡∏Ø {{ e+1 }}</span>

      <!-- ‡∏õ‡∏∏‡πà‡∏° ‚Äú‡∏ú‡πà‡∏≤‡∏ô / ‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô‚Äù (‡∏°‡∏µ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Ç‡∏±‡πâ‡∏ô 9) -->
      <div class="btn-group" role="group">
        <input  type="radio" class="btn-check"
                name="vote-{{ step.id }}-{{ e }}"
                id="pass-{{ step.id }}-{{ e }}"
                onchange="setExpertVote({{ step.id }}, {{ e }}, true)">
        <label  class="btn btn-outline-success btn-sm"
                for="pass-{{ step.id }}-{{ e }}">‡∏ú‡πà‡∏≤‡∏ô</label>

        <input  type="radio" class="btn-check"
                name="vote-{{ step.id }}-{{ e }}"
                id="fail-{{ step.id }}-{{ e }}"
                onchange="setExpertVote({{ step.id }}, {{ e }}, false)">
        <label  class="btn btn-outline-danger btn-sm"
                for="fail-{{ step.id }}-{{ e }}">‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô</label>
      </div>

    </div>
    {% endfor %}

  </div>
{% endif %}





      </div> <!-- /.timeline-content -->
    </li>
    {% endif %}
  {% endfor %}
{% else %}
  {# ‚Ä¶ ‡∏ö‡∏•‡πá‡∏≠‡∏Å default_titles ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏° ‚Ä¶ #}
{% endif %}
</ul>

</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
/* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ 1) ‡∏ï‡∏¥‡πä‡∏Å‡∏Ç‡∏±‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏Å ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
function toggleStep(cb, id){
  const ico  = document.getElementById(`ico-${id}`);
  const time = document.getElementById(`time-${id}`);

  ico.classList.toggle('checked',     cb.checked);
  ico.classList.toggle('bg-secondary',!cb.checked);

  fetch(`/toggle_step/${id}`,{
      method :'POST',
      headers:{'Content-Type':'application/json'},
      body   : JSON.stringify({done: cb.checked})
  })
  .then(r => r.json())
  .then(d => {
      if(!d.success){
          cb.checked = !cb.checked;               // rollback
          ico.classList.toggle('checked',     cb.checked);
          ico.classList.toggle('bg-secondary',!cb.checked);
          alert(d.message || 'server error');
          return;
      }
      if(time){
        if(cb.checked){
          const th = new Date().toLocaleString('th-TH',{
              timeZone:'Asia/Bangkok',
              day:'2-digit', month:'2-digit', year:'numeric',
              hour:'2-digit', minute:'2-digit'
          });
          time.innerHTML = `<i class="fas fa-clock"></i> ${th}`;
          time.classList.remove('d-none');
        }else{
          time.classList.add('d-none');
        }
      }
  })
  .catch(()=>alert('network error'));
}

/* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ 2) ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å comment ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
function saveComment(id){
  const box = document.getElementById(`cmt-${id}`);
  fetch(`/step_comment/${id}`,{
      method :'POST',
      headers:{'Content-Type':'application/json'},
      body   : JSON.stringify({comment: box.value.trim()})
  })
  .then(r => r.json())
  .then(d => {
      if(d.success){
          box.classList.add('border-flash');
          setTimeout(()=>box.classList.remove('border-flash'), 800);
      }else{
          alert(d.message || 'error');
      }
  })
  .catch(()=>alert('network error'));
}

/* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ 3) ‡∏ú‡∏π‡πâ‡∏ó‡∏£‡∏á‡∏Ø ‡∏™‡πà‡∏á‡∏ú‡∏•‡πÅ‡∏•‡πâ‡∏ß / ‡∏¢‡∏±‡∏á ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
function toggleExpert(cb, stepId, idx){
  fetch(`/expert_toggle/${stepId}/${idx}`,{
      method :'POST',
      headers:{'Content-Type':'application/json'},
      body   : JSON.stringify({done: cb.checked})
  })
  .then(r=>r.json())
  .then(d=>{
      if(!d.success){
          cb.checked = !cb.checked;              // rollback
          alert(d.message || 'server error');
      }
  })
  .catch(()=>alert('network error'));
}

/* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ 4) ‡∏õ‡∏∏‡πà‡∏° ‚Äú‡∏ú‡πà‡∏≤‡∏ô / ‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô‚Äù ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
function setExpertVote(stepId, idx, approved){
  fetch(`/expert_vote/${stepId}/${idx}`,{
      method :'POST',
      headers:{'Content-Type':'application/json'},
      body   : JSON.stringify({approved})
  })
  .then(r=>r.json())
  .then(d=>{
      if(d.success){
          location.reload();                     // ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡πÉ‡∏´‡πâ timeline ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï
      }else{
          alert(d.message || 'server error');
      }
  })
  .catch(()=>alert('network error'));
}
</script>


</body>
</html>