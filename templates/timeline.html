<!DOCTYPE html>

<html lang="th">

<head>

    <meta charset="utf-8" />

    <title>ข้อมูลผู้ใช้ & สถานะ</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />

    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" rel="stylesheet" />

      <link rel="icon"

        href="{{ url_for('static', filename='images/Kalasin_University_Seal.svg.png') }}"

        type="image/x-icon">

    <style>

        /* --- General Styles --- */

        body {

            font-family: 'Poppins', sans-serif; /* หรือ 'Sarabun' สำหรับภาษาไทย */

            background-color: #f8f9fa; /* สีพื้นหลังอ่อนๆ */

        }

        .navbar { background: #000; }

        .box {

            background: #fff;

            border-radius: 12px;

            padding: 30px;

            box-shadow: 0 4px 12px rgba(0,0,0,.08);

            margin-top: 20px;

        }



/* --- User Info Card Styles --- */

.user-info-card {

    background-color: #fff;

    padding: 2rem;

    border-radius: 12px;

    border: 1px solid #e9ecef;

}



/* ▼▼▼ The fix is in this block ▼▼▼ */

.user-info-card h5 {

    font-weight: 600;

    display: flex;

    gap: 10px;

    align-items: center; /* This line vertically centers the items */

}

/* ▲▲▲ End of fix ▲▲▲ */



.user-info-card .user-avatar {

    font-size: 24px;

    background-color: #0d6efd;

    color: white;

    width: 50px;

    height: 50px;

    border-radius: 50%;

    display: inline-flex;

    align-items: center;

    justify-content: center;

}

.user-info-card p {

    color: #6c757d;

    margin-bottom: 0.5rem;

}

        }

        .user-info-card i {

            width: 20px;

            text-align: center;

            margin-right: 8px;

            color: #adb5bd;

        }



        /* --- Timeline Styles (New Design) --- */

        .timeline {

            position: relative;

            list-style: none;

            padding-left: 45px; /* เพิ่มระยะห่างด้านซ้าย */

            margin: 2rem 0 0 0;

        }

        .timeline::before {

            content: "";

            position: absolute;

            left: 15px; /* ตำแหน่งของเส้นกลาง */

            top: 5px;

            bottom: 5px;

            width: 2px; /* ความหนาของเส้น */

            background-color: #dee2e6; /* สีเส้น */

        }

        .timeline-item {

            position: relative;

            margin-bottom: 2rem; /* เพิ่มระยะห่างระหว่างรายการ */

        }

        .timeline-icon {

            position: absolute;

            left: -31px; /* จัดตำแหน่งไอคอนให้อยู่บนเส้น */

            top: 0;

            width: 32px;

            height: 32px;

            border-radius: 50%;

            background-color: #ced4da; /* สีเริ่มต้น (ยังไม่เสร็จ) */

            border: 4px solid #f8f9fa; /* สร้างขอบขาวรอบๆ */

            display: flex;

            align-items: center;

            justify-content: center;

        }

        .timeline-icon input[type="checkbox"] {

            opacity: 0; /* ซ่อน checkbox เดิม */

            position: absolute;

            inset: 0;

            z-index: 2;

            cursor: pointer;

        }

        /* สถานะเมื่อเสร็จแล้ว */

        .timeline-icon.checked {

            background-color: #0d6efd; /* สีฟ้า */

        }

        .timeline-icon.checked::after {

            content: "✓"; /* เพิ่มเครื่องหมายถูก */

            font-weight: bold;

            color: white;

            font-size: 16px;

        }

        .timeline-content {

            padding-left: 15px; /* ระยะห่างจากไอคอน */

        }

        .timeline-content h6 {

            font-weight: 600;

            margin-bottom: 0.25rem;

        }

        .done-time, .comment-wrapper {

            color: #6c757d;

            font-size: 0.9rem;

            display: flex;

            align-items: flex-start;

            gap: 8px;

        }

        .comment-wrapper i {

            margin-top: 6px; /* จัดตำแหน่งไอคอนให้อยู่กลางๆ */

        }

        /* ปรับสไตล์ Textarea ให้เหมือนข้อความธรรมดา */

        .comment-area {

            border: none !important;

            box-shadow: none !important;

            padding: 0 !important;

            resize: none;

            background-color: transparent !important;

            width: 100%;

            overflow-y: hidden; /* ซ่อน scrollbar */

        }

        .comment-area:focus {

            outline: none !important;

        }

        .comment-input-wrapper {

    display: flex;

    align-items: flex-start;

    gap: 8px;

    background-color: #f1f3f5; /* พื้นหลังสีเทาอ่อน */

    border: 1px solid #dee2e6; /* เส้นขอบ */

    border-radius: 8px; /* ขอบมน */

    padding: 8px 12px;

    margin-top: 8px;

    transition: border-color 0.2s ease, box-shadow 0.2s ease;

}

/* เมื่อผู้ใช้คลิกที่ช่องพิมพ์ */

.comment-input-wrapper:focus-within {

    border-color: #0d6efd; /* เส้นขอบเปลี่ยนเป็นสีฟ้า */

    box-shadow: 0 0 0 3px rgba(13, 110, 253, 0.2); /* เพิ่มเงาเรืองๆ */

}

.comment-input-wrapper i {

    color: #6c757d;

    margin-top: 5px;

}

.comment-input-wrapper .comment-area {

    background: transparent;

    border: none;

    box-shadow: none;

    padding: 0;

}

.comment-input-wrapper .comment-area:focus {

    outline: none;

}

.comment-wrapper {

    /* เพิ่มเส้นขอบ */

    border: 1px solid #dee2e6;

   

    /* ทำให้ขอบมน */

    border-radius: 8px;

   

    /* เพิ่มระยะห่างข้างใน */

    padding: 8px 12px;

   

    /* ใส่พื้นหลังสีเทาอ่อนๆ */

    background-color: #f1f3f5;

   

    /* เพิ่ม animation ตอนคลิก */

    transition: border-color 0.2s ease, box-shadow 0.2s ease;

}



/* เมื่อผู้ใช้คลิกพิมพ์ใน textarea ที่อยู่ข้างใน */

.comment-wrapper:focus-within {

    border-color: #0d6efd; /* เส้นขอบเปลี่ยนเป็นสีฟ้า */

    box-shadow: 0 0 0 3px rgba(13, 110, 253, 0.2); /* เพิ่มเงาเรืองๆ */

}

    </style>

</head>

<body>



<nav class="navbar navbar-expand-lg navbar-dark">

    <div class="container-fluid">

        <a class="navbar-brand ms-2 d-flex align-items: center" href="{{ url_for('admin_dashboard') }}">

            <img src="https://upload.wikimedia.org/wikipedia/th/4/4e/Kalasin_University_Seal.svg" style="height:50px;margin-right:10px">

            <strong>Kalasin University – Admin</strong>

        </a>

        <div class="ms-auto">

            <a href="{{ url_for('logout') }}" class="btn btn-danger fw-bold px-4 py-2">

                <i class="fas fa-sign-out-alt me-1"></i> ออกจากระบบ

            </a>

        </div>

    </div>

</nav>



<div class="container py-4">

    <div class="user-info-card">

        <div class="d-flex align-items-center mb-4">

            <div class="user-avatar me-3">

                <i class="fas fa-user"></i>

            </div>

            <div>

                <h5 class="mb-0">{{ user.first_name }} {{ user.last_name }}</h5>

                <p class="mb-0">{{ position_th }}</p>

            </div>

        </div>

        <div class="row">

            <div class="col-md-6">

                <p><i class="fas fa-user-circle"></i> <strong>ชื่อผู้ใช้:</strong> {{ user.username }}</p>

                <p><i class="fas fa-building-columns"></i> <strong>คณะ:</strong> {{ faculty_th }}</p>

                <p><i class="fas fa-user-tag"></i> <strong>บทบาท:</strong> {{ user.role }}</p>

            </div>

            <div class="col-md-6">

                <p><i class="fas fa-envelope"></i> <strong>อีเมล:</strong> {{ user.email }}</p>

                <p><i class="fas fa-phone"></i> <strong>เบอร์โทร:</strong> {{ user.phone or '—' }}</p>

            </div>

        </div>

    </div>

   

    <div class="box mt-4">

        <h4 class="mb-4"><i class="fas fa-list-check"></i> สถานะการดำเนินการ</h4>

        <ul class="timeline" id="timeline-container">

            {% for step in steps %}

                <li class="timeline-item">

                    <div class="timeline-icon {{ 'checked' if step.is_done else '' }}" id="ico-{{ step.id }}">

                        <input type="checkbox"

                               class="step-toggle-checkbox"

                               data-step-id="{{ step.id }}"

                               {% if step.is_done %}checked{% endif %}>

                    </div>



                    <div class="timeline-content">

                        <h6>{{ step.order_no }}. {{ step.title }}</h6>

                       

                        {% if step.show_time %}

                        <div id="time-{{ step.id }}" class="done-time {% if not (step.is_done and step.done_at) %}d-none{% endif %}">

                            {% if step.is_done and step.done_at %}

                                <i class="fas fa-clock"></i> <span>{{ step.done_at|th_time }}</span>

                            {% endif %}

                        </div>

                        {% endif %}



                        <div class="comment-wrapper mt-1">

                            <i class="fas fa-comment-dots"></i>

                            <textarea class="form-control comment-area"

                                      id="cmt-{{ step.id }}"

                                      data-step-id="{{ step.id }}"

                                      placeholder="เพิ่มหมายเหตุ..."

                                      rows="1">{{ step.comment or '' }}</textarea>

                        </div>



                         {% if step.order_no == 9 %}
<div class="experts-section mt-3 p-3 bg-light border rounded">
    <h6 class="mb-3">ผลการพิจารณาจากผู้ทรงคุณวุฒิ:</h6>
    <ul class="list-group list-group-flush">
        {% for expert in step.experts %}
            <li class="list-group-item px-0 d-flex justify-content-between align-items-center">
                <div class="form-check">
                    <input class="form-check-input expert-toggle-checkbox" 
                           type="checkbox" 
                           id="expert-done-{{ step.id }}-{{ loop.index0 }}"
                           data-step-id="{{ step.id }}"
                           data-idx="{{ loop.index0 }}"
                           {% if expert.done %}checked{% endif %}>
                    <label class="form-check-label" for="expert-done-{{ step.id }}-{{ loop.index0 }}">
                        ผู้ทรงคุณวุฒิ ท่านที่ {{ loop.index }}
                    </label>
                </div>
                
                <div class="vote-buttons">
                    <div class="form-check form-check-inline">
                        <input class="form-check-input expert-vote-radio" type="radio" 
                               name="vote-{{ step.id }}-{{ loop.index0 }}" 
                               id="approve-{{ step.id }}-{{ loop.index0 }}"
                               data-step-id="{{ step.id }}"
                               data-idx="{{ loop.index0 }}"
                               data-approved="true"
                               {% if expert.approved == True %}checked{% endif %}>
                        <label class="form-check-label text-success" for="approve-{{ step.id }}-{{ loop.index0 }}">เห็นชอบ</label>
                    </div>
                    <div class="form-check form-check-inline">
                        <input class="form-check-input expert-vote-radio" type="radio" 
                               name="vote-{{ step.id }}-{{ loop.index0 }}"
                               id="disapprove-{{ step.id }}-{{ loop.index0 }}"
                               data-step-id="{{ step.id }}"
                               data-idx="{{ loop.index0 }}"
                               data-approved="false"
                               {% if expert.approved == False %}checked{% endif %}>
                        <label class="form-check-label text-danger" for="disapprove-{{ step.id }}-{{ loop.index0 }}">ไม่เห็นชอบ</label>
                    </div>
                </div>
            </li>
        {% endfor %}
    </ul>
</div>
{% endif %}

                    </div>

                </li>

            {% endfor %}

        </ul>

    </div>

</div>







<script>

document.addEventListener('DOMContentLoaded', () => {



    const timeline = document.getElementById('timeline-container');

    if (!timeline) {

        console.error("ไม่พบ #timeline-container");

        return;

    }



    function sendRequest(url, data) {

        return fetch(url, {

            method: 'POST',

            headers: {'Content-Type': 'application/json'},

            body: JSON.stringify(data)

        }).then(res => {

            if (!res.ok) throw new Error('Server response was not ok.');

            return res.json();

        });

    }



    // --- Draft Manager (no changes here) ---

    const draftManager = {

        getKey: (id) => `draft_cmt-${id}`,

        load(textarea) {

            const cached = sessionStorage.getItem(this.getKey(textarea.dataset.stepId));

            if (cached) {

                textarea.value = cached;

            }

        },

        save(textarea) {

            sessionStorage.setItem(this.getKey(textarea.dataset.stepId), textarea.value);

        },

        clear(id) {

            sessionStorage.removeItem(this.getKey(id));

        }

    };

   

    document.querySelectorAll('.comment-area').forEach(draftManager.load.bind(draftManager));



    timeline.addEventListener('change', async (e) => {

        const target = e.target;

       

        // ===================================================================

        // ▼▼▼ This is the corrected block for handling the checkbox tick ▼▼▼

        // ===================================================================

        if (target.matches('.step-toggle-checkbox')) {

            const isChecking = target.checked;

            const currentLi = target.closest('.timeline-item');

           

            // --- Step order validation (no changes here) ---

            if (isChecking) {

                const previousLi = currentLi.previousElementSibling;

                if (previousLi && !previousLi.querySelector('.step-toggle-checkbox')?.checked) {

                    alert('กรุณาทำตามขั้นตอนก่อนหน้าให้เสร็จก่อน');

                    target.checked = false;

                    return;

                }

            } else {

                const nextLi = currentLi.nextElementSibling;

                if (nextLi && nextLi.querySelector('.step-toggle-checkbox')?.checked) {

                    alert('กรุณายกเลิกขั้นตอนถัดไปก่อนครับ');

                    target.checked = true;

                    return;

                }

            }

           

            const stepId = target.dataset.stepId;

            const icon = document.getElementById(`ico-${stepId}`);

            const timeEl = document.getElementById(`time-${stepId}`);

            const textarea = currentLi.querySelector('.comment-area');



            // ★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★

            // ★★★ The main fix: Send ONE request with BOTH pieces of data ★★★

            // ★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★

            icon.classList.toggle('checked', isChecking);

            icon.classList.toggle('bg-secondary', !isChecking);

           

            try {

                // Create a single data object with both status and comment

                const payload = {

                    done: isChecking,

                    comment: textarea.value.trim()

                };



                // Send the combined data to the single endpoint

                const data = await sendRequest(`/toggle_step/${stepId}`, payload);

               

                if (timeEl) {

                    timeEl.innerHTML = isChecking && data.done_at ? `<i class="fas fa-clock"></i> ${data.done_at}` : '';

                    timeEl.classList.toggle('d-none', !isChecking || !data.done_at);

                }

                draftManager.clear(stepId); // Clear the temp draft after successful save



            } catch (err) {

                alert('เกิดข้อผิดพลาดในการบันทึกสถานะ');

                // Revert the UI changes if the request fails

                target.checked = !isChecking;

                icon.classList.toggle('checked', !isChecking);

                icon.classList.toggle('bg-secondary', isChecking);

            }

        }

        // ===================================================================

        // ▲▲▲ End of the corrected block ▲▲▲

        // ===================================================================



        // --- Other event handlers (no changes here) ---

        if (target.matches('.expert-toggle-checkbox')) {

            const { stepId, idx } = target.dataset;

            try {

                await sendRequest(`/expert_toggle/${stepId}/${idx}`, { done: target.checked });

            } catch (err) {

                alert('Network error while toggling expert status.');

                target.checked = !target.checked;

            }

        }

        if (target.matches('.expert-vote-radio')) {

            const { stepId, idx, approved } = target.dataset;

            document.querySelectorAll('.comment-area').forEach(area => area.blur());

            await new Promise(resolve => setTimeout(resolve, 50));

            try {

                const data = await sendRequest(`/expert_vote/${stepId}/${idx}`, { approved: approved === 'true' });

                if (data.success) {

                    location.reload();

                }

            } catch (err) {

                alert('Network error while setting expert vote.');

            }

        }

    });

   

    // --- Other event listeners (no changes here) ---

    timeline.addEventListener('input', (e) => {

        if (e.target.matches('.comment-area')) {

            draftManager.save(e.target);

        }

    });



    timeline.addEventListener('blur', async (e) => {

        if (e.target.matches('.comment-area')) {

            const textarea = e.target;

            const stepId = textarea.dataset.stepId;

            try {

                const data = await sendRequest(`/step_comment/${stepId}`, { comment: textarea.value.trim() });

                if (data.success) {

                    draftManager.clear(stepId);

                    textarea.classList.add('border-flash');

                    setTimeout(() => textarea.classList.remove('border-flash'), 100);

                }

            } catch (err) {

                console.error("Failed to save comment:", err);

            }

        }

    }, true);

});

</script>



</body>



</html>