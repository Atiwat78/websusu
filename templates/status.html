<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600;700&display=swap" rel="stylesheet">
      <link rel="icon"
        href="{{ url_for('static', filename='images/Kalasin_University_Seal.svg.png') }}"
        type="image/x-icon">

<style>
    body {
        font-family: 'Sarabun', sans-serif;
        background-color: #f8f9fa;
    }
    .navbar {
        background: #000000;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    .profile-details .label {
        color: #6c757d;
        font-weight: 400;
    }
    .profile-details .value {
        font-weight: 600;
        color: #212529;
    }
    .timeline {
        position: relative;
        padding-left: 20px;
        margin: 1.5rem 0;
    }
    .timeline::before {
        content: '';
        position: absolute;
        top: 10px;
        bottom: 10px;
        left: 26px;
        width: 3px;
        background-color: #e9ecef;
        border-radius: 2px;
    }
    .timeline-item {
        position: relative;
        padding-left: 35px;
        margin-bottom: 2rem;
    }
    .timeline-icon {
        position: absolute;
        left: 0;
        top: 0;
        width: 32px;
        height: 32px;
        border-radius: 50%;
        background-color: #198754;
        color: #fff;
        text-align: center;
        line-height: 32px;
        font-size: 1rem;
        z-index: 1;
        border: 3px solid #f8f9fa;
    }
    .timeline-item:last-child .timeline-icon {
        background-color: #0d6efd;
    }
    .timeline-item:last-child .timeline-content h6 {
        color: #0d6efd;
        font-weight: 700;
    }
    .timeline-item:last-child .timeline-icon::after {
        content: '';
        position: absolute;
        top: -4px; left: -4px; right: -4px; bottom: -4px;
        border: 2px solid #0d6efd;
        border-radius: 50%;
        animation: pulse 1.5s infinite;
    }
    .timeline-content {
        padding-top: 5px;
    }
    .timeline-content h6 {
        margin: 0 0 0.25rem;
        font-weight: 600;
        color: #343a40;
    }
    .time-text {
        display: block;
        font-size: 0.8rem;
        color: #6c757d;
    }
    .comment-block {
        background-color: #f8f9fa;
        border-left: 4px solid #ced4da;
        padding: 10px 15px;
        margin-top: 0.75rem;
        border-radius: 0 4px 4px 0;
    }
    
    @keyframes pulse {
        0% { transform: scale(0.9); opacity: 0.7; }
        70% { transform: scale(1.2); opacity: 0; }
        100% { transform: scale(0.9); opacity: 0; }
    }
</style>
</head>
<body>

    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="{{ url_for('user_dashboard') }}">
                <img src="https://upload.wikimedia.org/wikipedia/th/thumb/4/4e/Kalasin_University_Seal.svg/1200px-Kalasin_University_Seal.svg.png" alt="Kalasin University Logo" style="height:50px;margin-right:10px;">
                <strong>Kalasin University</strong>
            </a>
            <div class="ms-auto d-flex">
                <a href="{{ url_for('user_dashboard') }}" class="btn btn-light fw-bold px-4 py-2 me-2">
                    <i class="fas fa-home"></i> ‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å
                </a>
                <a href="{{ url_for('status') }}" class="btn btn-primary fw-bold px-4 py-2 me-2">
                    <i class="fas fa-chart-line"></i> ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
                </a>
                <a href="{{ url_for('logout') }}" class="btn btn-danger fw-bold px-4 py-2">
                    <i class="fas fa-sign-out-alt"></i> ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö
                </a>
            </div>
        </div>
    </nav>

    <div class="container mt-5">
        <div class="card shadow-sm mb-4">
            <div class="card-body p-4">
                <div class="d-flex align-items-center mb-4">
                    <div class="flex-shrink-0 me-3">
                        <div class="bg-primary text-white rounded-circle d-flex align-items-center justify-content-center" style="width: 60px; height: 60px;">
                            <i class="fas fa-user fa-2x"></i>
                        </div>
                    </div>
                    <div class="flex-grow-1">
                        <h2 class="mb-0">{{ first_name }} {{ last_name }}</h2>
                        <p class="text-muted mb-0 fs-5">{{ position }}</p>
                    </div>
                </div>

                <div class="profile-details">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="row mb-2">
                                <div class="col-4 label"><i class="fas fa-user-tag fa-fw me-2"></i>‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</div>
                                <div class="col-8 value">{{ username }}</div>
                            </div>
                            <div class="row mb-2">
                                <div class="col-4 label"><i class="fas fa-university fa-fw me-2"></i>‡∏Ñ‡∏ì‡∏∞</div>
                                <div class="col-8 value">{{ faculty }}</div>
                            </div>
                            <div class="row mb-2">
                                <div class="col-4 label"><i class="fas fa-shield-halved fa-fw me-2"></i>‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó</div>
                                <div class="col-8 value text-capitalize">{{ role }}</div>
                            </div>
                        </div>
                        <div class="col-md-6">
                             <div class="row mb-2">
                                <div class="col-4 label"><i class="fas fa-envelope fa-fw me-2"></i>‡∏≠‡∏µ‡πÄ‡∏°‡∏•</div>
                                <div class="col-8 value">{{ email }}</div>
                            </div>
                            <div class="row mb-2">
                                <div class="col-4 label"><i class="fas fa-phone fa-fw me-2"></i>‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£</div>
                                <div class="col-8 value">{{ user.phone or '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏' }}</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        {% set done_steps = steps | selectattr('is_done') | list %}
        {% if done_steps %}
        <div class="card shadow-sm">
            <div class="card-header bg-white border-0 pt-4">
                <h3><i class="fas fa-list-check me-2"></i>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</h3>
            </div>
            <div class="card-body">
                <ul class="timeline">
                    {% for step in done_steps %}
                    <li class="timeline-item">
                        <span class="timeline-icon">
                            <i class="fas fa-check"></i>
                        </span>
                        <div class="timeline-content">
                            <h6>{{ step.order_no }}. {{ step.title }}</h6>
                            {% if step.show_time and step.done_at %}
                            <small class="time-text">
                                <i class="fas fa-clock"></i> {{ step.done_at|th_time }}
                            </small>
                            {% endif %}
                            
                            <div id="comment-container-{{ step.id }}">
                                <div class="comment-block {% if not step.comment %}d-none{% endif %}" id="comment-block-{{ step.id }}">
                                    <p class="mb-0 small fst-italic" id="comment-text-{{ step.id }}">
                                        {% if step.comment %}
                                            <i class="fas fa-comment-dots fa-fw me-1"></i>
                                            {{ step.comment | nl2br | safe }}
                                        {% endif %}
                                    </p>
                                </div>
                            </div>
                            </div>
                    </li>
                    {% endfor %}
                </ul>
            </div>
        </div>
        {% endif %}

    </div> 

<script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>

<script>
document.addEventListener('DOMContentLoaded', () => {
    // ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö Server
    const socket = io();

    // ‡∏î‡∏∂‡∏á user id ‡∏à‡∏≤‡∏Å template ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏ä‡πâ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏´‡πâ‡∏≠‡∏á
    const userId = {{ user.id }}; 
    const roomName = `timeline-${userId}`;
    
    // ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‡πÉ‡∏´‡πâ‡∏™‡πà‡∏á event 'join' ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡∏´‡πâ‡∏≠‡∏á‡∏Ç‡∏≠‡∏á‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á
    socket.on('connect', () => {
        socket.emit('join', { room: roomName });
        console.log(`üéß User page connected. Joined room: ${roomName}`);
    });

    // ‚òÖ‚òÖ‚òÖ ‡∏™‡πà‡∏ß‡∏ô‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î: ‡∏£‡∏≠‡∏ü‡∏±‡∏á event ‡∏ä‡∏∑‡πà‡∏≠ 'comment_update' ‚òÖ‚òÖ‚òÖ
    socket.on('comment_update', (data) => {
        console.log('üì° Received real-time update:', data);
        
        // ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‡πÉ‡∏´‡πâ‡∏´‡∏≤ element ‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á
        const commentBlock = document.getElementById(`comment-block-${data.step_id}`);
        const commentText = document.getElementById(`comment-text-${data.step_id}`);

        if (commentBlock && commentText) {
            // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÉ‡∏´‡∏°‡πà‡∏™‡πà‡∏á‡∏°‡∏≤
            if (data.text && data.text.trim() !== '') {
                // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡πÉ‡∏ô HTML ‡πÅ‡∏•‡∏∞‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡∏°‡∏±‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•
                commentText.innerHTML = `<i class="fas fa-comment-dots fa-fw me-1"></i> ${data.text.replace(/\n/g, '<br>')}`;
                commentBlock.classList.remove('d-none');
            } else {
                // ‡∏ñ‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÉ‡∏´‡∏°‡πà‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡πà‡∏≤‡∏ß‡πà‡∏≤‡∏á ‡πÉ‡∏´‡πâ‡∏ã‡πà‡∏≠‡∏ô‡∏Å‡∏•‡πà‡∏≠‡∏á comment
                commentBlock.classList.add('d-none');
                commentText.innerHTML = '';
            }
        }
    });
});
</script>
</body>
</html>